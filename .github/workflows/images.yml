name: "Publish images"

on:
  push:
    branches:
      - "k[0-9]+*"
      - "main"
  workflow_dispatch: {}

permissions:
  contents: "write"
  id-token: "write"
  pull-requests: "write"

env:
  BUILD_TIMEOUT: "60"
  GO_VERSION: "1.23.6"
  IMAGE_PREFIX: "grafana"
  RELEASE_LIB_REF: "main"
  RELEASE_REPO: "grafana/loki"

jobs:
  check:
    uses: "grafana/loki-release/.github/workflows/check.yml@main"
    with:
      build_image: "grafana/loki-build-image:0.34.5"
      golang_ci_lint_version: "v1.60.3"
      release_lib_ref: "main"
      skip_validation: false
      use_github_app_token: true

  loki-canary-boringcrypto:
    needs: [check]
    uses: ./.github/workflows/docker-build.yml
    with:
      image_name: loki-canary-boringcrypto
      dockerfile_path: cmd/loki-canary-boringcrypto/Dockerfile
      release_lib_ref: main
      release_repo: grafana/loki

  loki-canary:
    needs: [check]
    uses: ./.github/workflows/docker-build.yml
    with:
      image_name: loki-canary
      dockerfile_path: cmd/loki-canary/Dockerfile
      release_lib_ref: main
      release_repo: grafana/loki

  loki:
    needs: [check]
    uses: ./.github/workflows/docker-build.yml
    with:
      image_name: loki
      dockerfile_path: cmd/loki/Dockerfile
      release_lib_ref: main
      release_repo: grafana/loki

  promtail:
    needs: [check]
    uses: ./.github/workflows/docker-build.yml
    with:
      image_name: promtail
      dockerfile_path: clients/cmd/promtail/Dockerfile
      release_lib_ref: main
      release_repo: grafana/loki

  lambda-promtail:
    needs: [check]
    uses: ./.github/workflows/docker-build.yml
    with:
      image_name: lambda-promtail
      dockerfile_path: tools/lambda-promtail/Dockerfile
      image_prefix: public.ecr.aws/grafana
      release_lib_ref: main
      release_repo: grafana/loki
      use_ecr: true
