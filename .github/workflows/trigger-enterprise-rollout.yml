name: Trigger Enterprise Rollout

on:
  push:
    branches:
      - main

jobs:
  trigger-rollout:
    if: github.repository == 'grafana/loki'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
      pull-requests: "write"
    
    steps:
      - name: Checkout Actions
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Retrieve Loki GitHub App Credentials from Vault
        id: get-loki-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@28361cdb22223e5f1e34358c86c20908e7248760
        with:
          repo_secrets: |
            APP_ID=loki-gh-app:app-id
            PRIVATE_KEY=loki-gh-app:private-key

      - name: Generate GitHub App Token
        id: loki-app-token
        uses: "actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547" # v1
        with:
          # Variables generated by the previous step get-secrets
          app-id: ${{ steps.get-loki-secrets.outputs.APP_ID }}
          private-key: ${{ env.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Trigger main-rollout workflow in enterprise-logs
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: 'grafana',
              repo: 'enterprise-logs',
              workflow_id: 'main-images',
              ref: 'main',
              inputs: {
                triggered_by: 'loki',
                loki_commit: context.sha,
                loki_ref: context.ref
              }
            });
            console.log('Triggered main-rollout workflow in enterprise-logs repository');
            console.log('Response status:', response.status);

