---
name: lint
on: [pull_request]
  # pull_request:
  #   paths: "production/**"

jobs:
  lint-jsonnet:
    name: Lint jsonnet files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
      - name: Setup jsonnet
        run: |
          go install github.com/google/go-jsonnet/cmd/jsonnet@v0.20.0
          go install github.com/google/go-jsonnet/cmd/jsonnetfmt@v0.20.0
          go install github.com/google/go-jsonnet/cmd/jsonnet-lint@v0.20.0
          go install github.com/monitoring-mixins/mixtool/cmd/mixtool@16dc166166d91e93475b86b9355a4faed2400c18
          go install github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb@v0.5.1
      - name: Run jsonnet linter
        run: make BUILD_IN_CONTAINER=false lint-jsonnet
      - name: Check mixin
        run: |
          make BUILD_IN_CONTAINER=false loki-mixin-check

  lint-dockerfile:
    name: Lint Docker files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
      - name: Setup dockerfmt
        run: |
          go install github.com/reteps/dockerfmt@0.3.4
      - name: Run dockerfmt
        run: make BUILD_IN_CONTAINER=false fmt-dockerfile
      - name: Check drift
        run: |
          git diff
          git diff-index --quiet HEAD --
