---
name: helm-loki-ci
on:
  pull_request:
    paths:
      - "production/helm/loki/**"

jobs:
  publish-diff:
    name: Publish Rendered Helm Chart Diff
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Add required Helm repositories
        run: |
          helm repo add minio https://charts.min.io/
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add grafana-operator https://grafana.github.io/helm-charts
          helm repo update

      - name: Setup K3D
        uses: ./.github/actions/setup-k3d

      - name: Setup Helm plugins
        run: |
          helm plugin install https://github.com/databus23/helm-diff

      - name: Build helm dependencies
        run: |
          helm dependency build production/helm/loki

      - name: Install latest helm release
        run: |
          helm install --create-namespace loki-release grafana/loki -f production/helm/loki/scenarios/default-single-binary-values.yaml --version 6.21.0

      - name: Run helm diff
        env:
          HELM_DIFF_USE_UPGRADE_DRY_RUN: true
        run: |
          helm diff upgrade loki-release -f production/helm/loki/scenarios/default-single-binary-values.yaml production/helm/loki > helm_diff_output.txt

      - name: Parse Helm Diff Output
        id: parse_diff
        run: |
          echo "### Helm Diff Output" > parsed_diff_output.txt
          echo "#### Added" >> parsed_diff_output.txt
          grep '^+' helm_diff_output.txt | grep -v '^+++' >> parsed_diff_output.txt
          echo "#### Modified" >> parsed_diff_output.txt
          grep '^!' helm_diff_output.txt >> parsed_diff_output.txt
          echo "#### Removed" >> parsed_diff_output.txt
          grep '^-' helm_diff_output.txt | grep -v '^---' >> parsed_diff_output.txt
          cat parsed_diff_output.txt

      - name: Post Parsed Helm Diff Output as PR Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const parsedDiffOutput = fs.readFileSync('parsed_diff_output.txt', 'utf8');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: parsedDiffOutput
            });
