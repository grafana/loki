name: operator images

on:
  push:
    paths:
      - 'operator/**'
    branches:
      - main
  pull_request:
    paths:
      - 'operator/**'
  workflow_dispatch:

env:
  IMAGE_REGISTRY: quay.io
  IMAGE_ORGANIZATION: openshift-logging

jobs:
  # Push latest to DockerHub (grafana) on main
  publish-grafana-operator:
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/operator-reusable-image-build.yml
    with:
      context: "operator"
      dockerfile: "operator/Dockerfile"
      registry: "docker.io"
      organization: "grafana"
      image_name: "loki-operator"
      tag: "latest"

  # Build and push operator to Quay.io (runs on both main and PRs)
  publish-openshift-operator:
    uses: ./.github/workflows/operator-reusable-image-build.yml
    with:
      context: "operator"
      dockerfile: "operator/Dockerfile"
      registry: "quay.io"
      organization: "openshift-logging"
      image_name: "loki-operator"
      tag: ${{ github.event_name == 'pull_request' && format('pr{0}', github.event.pull_request.number) || 'latest' }}

  # Build and push bundle to Quay.io (main only)
  publish-openshift-bundle:
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/operator-reusable-image-build.yml
    with:
      context: "operator/bundle/openshift"
      dockerfile: "operator/bundle/openshift/bundle.Dockerfile"
      registry: "quay.io"
      organization: "openshift-logging"
      image_name: "loki-operator-bundle"
      tag: "latest"

  # Build and push size-calculator to Quay.io (main only)
  publish-openshift-size-calculator:
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/operator-reusable-image-build.yml
    with:
      context: "operator"
      dockerfile: "operator/calculator.Dockerfile"
      registry: "quay.io"
      organization: "openshift-logging"
      image_name: "storage-size-calculator"
      tag: "latest"