---
name: 'debug image push'
on:
  workflow_dispatch: {}
permissions:
  contents: write
  pull-requests: write
jobs:
  push:
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v4"
        with:
          path: "release"
          repository: grafana/loki-release
      - name: "pull release library code"
        uses: "actions/checkout@v4"
        with:
          path: "lib"
          repository: "grafana/loki-release"
      - name: "setup node"
        uses: "actions/setup-node@v4"
        with:
          node-version: 20
      - env:
          ACTIONS_STEP_DEBUG: "true"
        name: "auth gcs"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}"
      - name: "Set up QEMU"
        uses: "docker/setup-qemu-action@v3"
      - name: "set up docker buildx"
        uses: "docker/setup-buildx-action@v3"
      - name: "docker login"
        uses: "docker/login-action@v3"
        with:
          password: "${{ secrets.DOCKER_PASSWORD }}"
          username: "${{ inputs.docker_username }}"
      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"
        with:
          version: ">= 452.0.0"
      - name: "download build artifacts"
        run: |
          sha="21935215a13082416744dc6e77fce1155888e90c"
          echo "downloading binaries to $(pwd)/dist"
          gsutil cp -r gs://loki-build-artifacts/${sha}/dist .

          echo "downloading binaries to $(pwd)/images"
          gsutil cp -r gs://loki-build-artifacts/${sha}/images .
        shell: "bash"
        working-directory: "release"
      - env:
          ACTIONS_STEP_DEBUG: true
        name: "push docker images"
        uses: "./lib/actions/push-images"
        with:
          imageDir: "release/images"
          imagePrefix: "${{ inputs.image_prefix }}"
