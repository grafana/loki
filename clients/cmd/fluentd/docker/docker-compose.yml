services:
  loki:
    build:
      context: ../../../../
      dockerfile: ./cmd/loki/Dockerfile
    image: grafana/loki:main
    ports:
      - 3100:3100

  # Receive forwarded logs and send to /fluentd/logs/data.log and loki
  fluentd:
    build:
      context: ../../../../
      dockerfile: ./clients/cmd/fluentd/Dockerfile
    image: grafana/fluent-plugin-loki:main
    ports:
      - 8080:8080
    volumes:
      - ./fluentd.conf:/fluentd/etc/fluent.conf
      - ./conf/loki.conf:/fluentd/etc/loki.conf
      - ../lib/fluent/plugin/out_loki.rb:/fluentd/plugins/out_loki.rb
    environment:
      - LOKI_URL=http://loki:3100
    depends_on:
      - loki

  # Read /var/log/syslog and send it to fluentd
  fluentbit:
    image: fluent/fluent-bit:4.0
    command: "/fluent-bit/bin/fluent-bit -c /srv/fluent-bit.conf"
    user: root
    volumes:
      - ./fluent-bit.conf:/srv/fluent-bit.conf
      - /var/log/syslog:/var/log/syslog:ro
    depends_on:
      - fluentd
      - loki
