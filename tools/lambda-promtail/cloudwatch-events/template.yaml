AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  lambda-promtail:
  
  propagate Cloudwatch Events to Loki via Promtail.

Parameters:
  PromtailAddress:
    Description: 'address for promtail in the form of: http<s>://<location><:port>/loki/api/v1/push'
    Type: String
    Default: 'http://localhost:8080/loki/api/v1/push'
  ReservedConcurrency:
    Description: The maximum of concurrent executions you want to reserve for the function.
    Type: Number
    Default: 2
  EventSources:
    Type: CommaDelimitedList
    Default: '*'
    Description: 'Event sources to forward to Loki. Use "*" for all CloudWatch
      events. Use comma delimited list for multiple sources, for example: "aws.ec2,aws.s3".'

Conditions:
  AllCWEvents:
    Fn::Equals:
    - Fn::Select:
      - 0
      - Ref: EventSources
    - '*'

Resources:
  LambdaPromtailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambda-promtail/
      Handler: handler
      MemorySize: 128
      Timeout: 60
      EventInvokeConfig:
        MaximumRetryAttempts: 2
      ReservedConcurrentExecutions: !Ref ReservedConcurrency
      # # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-vpcconfig.html
      # VpcConfig:
      Runtime: go1.x
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - 'ec2:Describe*' 
            Resource: '*'
      Events:
        CWEvent:
          Type: CloudWatchEvent
          Properties:
            Pattern:
              source:
                Fn::If:
                - AllCWEvents
                - - prefix: aws
                - Ref: EventSources
      Environment: # More info about Env Vars: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#environment-object
        Variables:
          PROMTAIL_ADDRESS: !Ref PromtailAddress

Outputs:
  LambdaPromtailFunction:
    Description: "Lambda Promtail Function ARN"
    Value: !GetAtt LambdaPromtailFunction.Arn

