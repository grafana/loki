# Microservices mode

This Nomad job will deploy a Loki in
[microservices mode](https://grafana.com/docs/loki/latest/fundamentals/architecture/deployment-modes/#microservices-mode)
using boltdb-shipper and S3 backend GRPC protected with mTLS and with HTTP
endpoinds accessible only through Traefik+Consul Connect.

Make sure to go over the job file and adjust it to your needs.

## Secure endpoints

Unfortenately Consul Connect cannot be used to secure GRPC communication between
Loki components, since some components should be able to connect to all
instances of other components. That is why internal Loki components
communication happening over GRPC are secured with mTLS with certificates
provisioned with Vault PKI. HTTP (user and external facing endpoints) are
protected with Consul Connect.

### HTTP

HTTP endpoints are hidden behind Consul Connect.

Ring endpoints are exposed through Traefik for operator and must be protected by
basicauth. Example:

```hcl
tags = [
  "traefik.enable=true",
  "traefik.consulcatalog.connect=true",

  "traefik.http.routers.loki-ingester-ring.entrypoints=https",
  "traefik.http.routers.loki-ingester-ring.rule=Host(`loki-ingester.service.consul`) && Path(`/ring`)",
  "traefik.http.middlewares.loki-ingester-ring.basicauth.users=devops:$apr11bMKZL02A$QrOgT3NAOx.koXWnqfXbo0",
  "traefik.http.routers.loki-ingester-ring.middlewares=loki-ingester-ring@consulcatalog",
]
```

Read and write path (including ruler api) are also exposed and must be protected
by basicauth. Example:

```hcl
tags = [
  "traefik.enable=true",
  "traefik.consulcatalog.connect=true",

  "traefik.http.routers.loki-distributor.entrypoints=https",
  "traefik.http.routers.loki-distributor.rule=Host(`loki-distributor.service.consul`)",
  "traefik.http.middlewares.loki-distributor.basicauth.users=promtail:$apr1$y5tgAEDC$8SHWJq7aBoDd0qnOTQkok0",
  "traefik.http.routers.loki-distributor.middlewares=loki-distributor@consulcatalog",

  "traefik.http.routers.loki-distributor-ring.entrypoints=https",
  "traefik.http.routers.loki-distributor-ring.rule=Host(`loki-distributor.service.consul`) && Path(`/distributor/ring`)",
  "traefik.http.middlewares.loki-distributor-ring.basicauth.users=devops:$apr11bMKZL02A$QrOgT3NAOx.koXWnqfXbo0",
  "traefik.http.routers.loki-distributor-ring.middlewares=loki-distributor-ring@consulcatalog",
]
```

### GRPC

GRPC endpoints are using self-signed certificates generated by
[Vault](https://www.vaultproject.io/docs/secrets/pki).

### `/metrics` and `/ready` endpoints

Exposed with
[`expose` stanza](https://www.nomadproject.io/docs/job-specification/expose)

## Gather metrics

To collect metrics from all components use this config:

```yaml
- job_name: "loki"
  consul_sd_configs:
    - services:
        - "loki-compactor"
        - "loki-ruler"
        - "loki-distributor"
        - "loki-ingestor"
        - "loki-querier"
        - "loki-index-gateway"
        - "loki-query-frontend"
        - "loki-query-scheduler"
  relabel_configs:
    - source_labels: ["__meta_consul_service_metadata_alloc_id"]
      target_label: "instance"
    - source_labels: ["__meta_consul_service_metadata_component"]
      target_label: "component"
```
